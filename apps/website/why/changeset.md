# monorepo å¦‚ä½•å‘åŒ…å’Œç”Ÿæˆå˜æ›´æ—¥å¿—

åœ¨ `monorepo` ä¸­å‘åŒ…å’Œç”Ÿæˆå˜æ›´æ—¥å¿—æ˜¯ä¸€é¡¹å…³é”®çš„å·¥ä½œã€‚æ¨èçš„ç°ä»£åšæ³•æ˜¯ä½¿ç”¨ [`changesets`](https://github.com/changesets/changesets) ä¸“ä¸º **monorepo åŒ…å‘å¸ƒ** è®¾è®¡çš„å¼€æºå·¥å…·ã€‚

## changesets æ˜¯ä»€ä¹ˆï¼Ÿ

`changesets` æ˜¯ä¸€æ¬¾ç”¨äºï¼š

- è®°å½•æ¯ä¸ªå˜æ›´çš„ç›®çš„å’Œç‰ˆæœ¬å½±å“
- è‡ªåŠ¨ç”Ÿæˆå˜æ›´æ—¥å¿—ï¼ˆ`CHANGELOG.md`ï¼‰
- è‡ªåŠ¨å†³å®šè¦å‘å¸ƒå“ªäº›åŒ…ï¼Œä»¥åŠä½¿ç”¨ä»€ä¹ˆè¯­ä¹‰ç‰ˆæœ¬ï¼ˆ`major` /`minor`/ `patch`ï¼‰
- ä¸ `CI/CD` é›†æˆå®ç°è‡ªåŠ¨å‘å¸ƒï¼ˆæ”¯æŒ `GitHub Actions`ï¼‰

## ä½¿ç”¨ changesets çš„ä¼˜åŠ¿

| ä¼˜åŠ¿            | è¯´æ˜                                                          |
| --------------- | ------------------------------------------------------------- |
| âœ… ç²¾ç»†æ§åˆ¶     | æ¯æ¬¡å˜æ›´å•ç‹¬å†™ä¸€ä¸ª changeset æ–‡ä»¶ï¼Œæ˜ç¡®è¯´æ˜å½±å“çš„åŒ…å’Œå˜æ›´ç±»å‹ |
| ğŸ“¦ æ”¯æŒå¤šåŒ…     | è‡ªåŠ¨è¯†åˆ«å“ªäº›åŒ…å‘ç”Ÿäº†å˜æ›´ï¼Œä»¥åŠå®ƒä»¬çš„ä¾èµ–æ˜¯å¦ä¹Ÿéœ€è¦å‘å¸ƒ        |
| ğŸ§¾ è‡ªåŠ¨ç”Ÿæˆæ—¥å¿— | åŸºäº changeset æ–‡ä»¶ç”Ÿæˆç»“æ„æ¸…æ™°çš„ CHANGELOG.md                |
| ğŸ”„ è‡ªåŠ¨å‡çº§ç‰ˆæœ¬ | éµå¾ª Semver è§„èŒƒï¼Œè‡ªåŠ¨å¤„ç†åŒ…ä¹‹é—´çš„ä¾èµ–å‡çº§                    |
| ğŸ¤– CI/CD é›†æˆ   | æ”¯æŒ GitHub Actions è‡ªåŠ¨åˆ›å»ºç‰ˆæœ¬ PR å¹¶å‘å¸ƒåˆ° NPM              |

## å¦‚ä½•åœ¨ monorepo ä¸­ä½¿ç”¨ changesetsï¼ˆpnpm + turboï¼‰

### 1. å®‰è£…ä¾èµ–

```bash
pnpm add -D @changesets/cli
pnpm changeset init
```

ä¼šç”Ÿæˆï¼š

```bash
.changeset/         # å­˜æ”¾æ¯æ¬¡å˜æ›´çš„ YAML æ–‡ä»¶
  â””â”€â”€ cool-change.md
```

---

### 2. ç¼–å†™ changeset

è¿è¡Œä»¥ä¸‹å‘½ä»¤ä¸ºä¸€æ¬¡å˜æ›´åˆ›å»ºè®°å½•ï¼š

```bash
pnpm changeset
```

äº¤äº’å¼è¾“å…¥ï¼š

- é€‰æ‹©å—å½±å“çš„åŒ…ï¼ˆå¤šä¸ªï¼‰
- é€‰æ‹©ç‰ˆæœ¬å˜æ›´ç±»å‹ï¼ˆpatch / minor / majorï¼‰
- è¾“å…¥ changelog ä¿¡æ¯

ç»“æœç¤ºä¾‹ï¼ˆ`.changeset/awesome-change.md`ï¼‰ï¼š

```md
---
"@my/utils": minor
"@my/ui": patch
---

feat: æ–°å¢æ—¶é—´å·¥å…·ï¼›
fix: ä¿®å¤ UI æŒ‰é’®é¢œè‰²ã€‚
```

---

### 3. ç‰ˆæœ¬å·å‡çº§ + changelog ç”Ÿæˆ

åœ¨åˆå¹¶å˜æ›´åï¼Œè¿è¡Œï¼š

```bash
pnpm changeset version
```

å®ƒä¼šï¼š

- æ›´æ–°æ¯ä¸ªåŒ…çš„ `package.json` ç‰ˆæœ¬å·
- ä¿®æ”¹ä¾èµ–åŒ…å¼•ç”¨ç‰ˆæœ¬
- æ›´æ–°æ¯ä¸ªåŒ…çš„ `CHANGELOG.md`

---

### 4. å‘å¸ƒåˆ° NPM

```bash
pnpm changeset publish
```

è‡ªåŠ¨ï¼š

- å‘å¸ƒå·²å˜æ›´çš„åŒ…
- å¿½ç•¥æœªå˜æ›´çš„åŒ…
- ä½¿ç”¨ monorepo ä¸­æ­£ç¡®çš„ä¾èµ–ç‰ˆæœ¬

---

### 5. é…åˆ GitHub Actions è‡ªåŠ¨å‘å¸ƒï¼ˆå¯é€‰ï¼‰

å»ºè®®ä½¿ç”¨å®˜æ–¹æä¾›çš„ `create-release` GitHub Actionï¼š

```yaml
name: Release
on:
  push:
    branches:
      - main

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
        with:
          version: 8
      - run: pnpm install
      - run: pnpm changeset version
      - run: pnpm changeset publish
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
```

---

## ä¸å…¶ä»–æ–¹æ¡ˆå¯¹æ¯”ï¼ˆå¦‚ lernaã€æ‰‹åŠ¨è„šæœ¬ï¼‰

| åŠŸèƒ½          | `changesets`   | `lerna`       | æ‰‹åŠ¨è„šæœ¬ |
| ------------- | -------------- | ------------- | -------- |
| å¤šåŒ…å‘å¸ƒæ”¯æŒ  | âœ…             | âœ…            | âŒ       |
| è‡ªåŠ¨ç”Ÿæˆæ—¥å¿—  | âœ…             | âŒ/éƒ¨åˆ†æ”¯æŒ   | âŒ       |
| ç²¾ç¡®æ§åˆ¶å˜æ›´  | âœ…ï¼ˆé€æ¡è®°å½•ï¼‰ | âŒ            | âŒ       |
| ç°ä»£åŒ–æ”¯æŒ    | âœ…ï¼ˆæ´»è·ƒç»´æŠ¤ï¼‰ | åœæ»/ç¤¾åŒºç»´æŠ¤ | âŒ       |
| ä¸ CI/CD é›†æˆ | âœ…             | éƒ¨åˆ†å¤æ‚      | âŒ       |

---

## ç¤ºä¾‹åœºæ™¯

æ¯”å¦‚ä½ åœ¨ monorepo ä¸­æ”¹äº† `@my/utils` å’Œ `@my/ui`ï¼Œä½ å¯ä»¥ï¼š

```bash
pnpm changeset
# ç„¶åå†™æ˜ï¼šutils ä¸º minorï¼Œui ä¸º patch

pnpm changeset version
# è‡ªåŠ¨å‡çº§ utils åˆ° 1.3.0ï¼Œui åˆ° 0.1.2ï¼Œå¹¶æ›´æ–° changelog

pnpm changeset publish
# å‘å¸ƒåˆ° npm
```

## æ€»ç»“

ä½¿ç”¨ `changesets`ï¼š

- æ˜¯ monorepo æœ€æ¨èçš„å‘åŒ… + changelog æ–¹æ¡ˆ
- æ­é… `pnpm + turbo` éå¸¸è‡ªç„¶
- æ”¯æŒå›¢é˜Ÿåä½œã€è‡ªåŠ¨åŒ–æµç¨‹ã€è¯­ä¹‰åŒ–ç‰ˆæœ¬ç®¡ç†
